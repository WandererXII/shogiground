var Shogiground=function(){"use strict";const e=["sente","gote"],o=["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"],t=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p"],n=Array.prototype.concat(...t.map((e=>o.map((o=>o+e))))),r=e=>n[e[0]+16*e[1]],s=e=>e.length>2?[e.charCodeAt(1)-39,e.charCodeAt(2)-97]:[e.charCodeAt(0)-49,e.charCodeAt(1)-97];function i(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}function a(e,...o){e&&setTimeout((()=>e(...o)),1)}const d=e=>"sente"===e?"gote":"sente",c=e=>"sente"===e,l=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},u=(e,o)=>e.role===o.role&&e.color===o.color,p=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],f=e=>(o,t)=>p(o,e,t,100,100),h=(e,o,t)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${t}`},g=(e,o,t,n)=>{e.style.transform=`translate(${o[0]*t}%,${o[1]*t}%) scale(${n||t})`},m=(e,o)=>{e.style.display=o?"":"none"},v=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},b=e=>2===e.buttons||2===e.button,w=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t};function C(e){return`${e.color} ${e.role}`}function y(e){return"PIECE"===e.tagName}function k(e){return"SQ"===e.tagName}function P(e,o,t,n){const r=s(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function O(e,o,t){const n=s(e);let r=t.files-1-n[0]+n[1]*t.files;return o||(r=t.files*t.ranks-1-r),r}function S(e,o){return e.left<=o[0]&&e.top<=o[1]&&e.left+e.width>o[0]&&e.top+e.height>o[1]}function M(e,o,t,n){let s=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(s=t.files-1-s);let i=Math.floor(t.ranks*(e[1]-n.top)/n.height);return o||(i=t.ranks-1-i),s>=0&&s<t.files&&i>=0&&i<t.ranks?r([s,i]):void 0}function B(o,t,n){for(const r of e)for(const e of t){const t={color:r,role:e},s=n.get(C(t));if(s&&S(s,o))return t}}function q(e,o,t,n,r){const s=r.width/n.files,i=r.height/n.ranks;if(!s||!i)return;let a=(e-r.left)/s;t&&(a=n.files-1-a);let d=(o-r.top)/i;return t||(d=n.ranks-1-d),[a,d]}function D(e,o,t=1){const n=e.hands.handMap.get(o.color),r=(e.hands.roles.includes(o.role)?o.role:e.promotion.unpromotesTo(o.role))||o.role;n&&e.hands.roles.includes(r)&&n.set(r,(n.get(r)||0)+t)}function E(e,o,t=1){const n=e.hands.handMap.get(o.color),r=(e.hands.roles.includes(o.role)?o.role:e.promotion.unpromotesTo(o.role))||o.role,s=null==n?void 0:n.get(r);n&&s&&n.set(r,Math.max(s-t,0))}function L(e,o){var t;o.classList.toggle("promotion",!!e.promotion.current);let n=o.firstElementChild;for(;n;){const o=n.firstElementChild,r={role:o.sgRole,color:o.sgColor},s=(null===(t=e.hands.handMap.get(r.color))||void 0===t?void 0:t.get(r.role))||0,i=!!e.selectedPiece&&u(r,e.selectedPiece)&&!e.droppable.spare;n.classList.toggle("selected",("both"===e.activeColor||e.activeColor===e.turnColor)&&i),n.classList.toggle("preselected","both"!==e.activeColor&&e.activeColor!==e.turnColor&&i),n.classList.toggle("drawing",!!e.drawable.piece&&u(e.drawable.piece,r)),n.classList.toggle("current-pre",!!e.predroppable.current&&u(e.predroppable.current.piece,r)),n.dataset.nb=s.toString(),n=n.nextElementSibling}}function R(e){e.premovable.current&&(e.premovable.current=void 0,a(e.premovable.events.unset))}function x(e){e.predroppable.current&&(e.predroppable.current=void 0,a(e.predroppable.events.unset))}function T(e,o,t,n){const r=e.pieces.get(o),s=e.pieces.get(t);if(o===t||!r)return!1;const i=s&&s.color!==r.color?s:void 0,d=n&&G(e,r);return t!==e.selected&&o!==e.selected||I(e),e.pieces.set(t,d||r),e.pieces.delete(o),e.lastDests=[o,t],e.checks=void 0,a(e.events.move,o,t,n,i),a(e.events.change),i||!0}function A(e,o,t,n){var r;const s=(null===(r=e.hands.handMap.get(o.color))||void 0===r?void 0:r.get(o.role))||0;if(!s&&!e.droppable.spare)return!1;const i=n&&G(e,o);return(t===e.selected||!e.droppable.spare&&1===s&&e.selectedPiece&&u(e.selectedPiece,o))&&I(e),e.pieces.set(t,i||o),e.lastDests=[t],e.checks=void 0,e.droppable.spare||E(e,o),a(e.events.drop,o,t,n),a(e.events.change),!0}function H(e,o,t,n){const r=T(e,o,t,n);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=d(e.turnColor),e.animation.current=void 0),r}function $(e,o,t,n){const r=A(e,o,t,n);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=d(e.turnColor),e.animation.current=void 0),r}function j(e,o,t,n){const r=n||e.promotion.forceDropPromotion(o,t);if(Z(e,o,t)){if($(e,o,t,r))return I(e),a(e.droppable.events.after,o,t,r,{premade:!1}),!0}else if(oe(e,o,t))return function(e,o,t,n){R(e),e.predroppable.current={piece:o,key:t,prom:n},a(e.predroppable.events.set,o,t,n)}(e,o,t,r),I(e),!0;return I(e),!1}function K(e,o,t,n){const r=n||e.promotion.forceMovePromotion(o,t);if(W(e,o,t)){const n=H(e,o,t,r);if(n){I(e);const s={premade:!1};return!0!==n&&(s.captured=n),a(e.movable.events.after,o,t,r,s),!0}}else if(ee(e,o,t))return function(e,o,t,n){x(e),e.premovable.current={orig:o,dest:t,prom:n},a(e.premovable.events.set,o,t,n)}(e,o,t,r),I(e),!0;return I(e),!1}function F(e,o,t){const n=G(e,o);return!(e.viewOnly||e.promotion.current||!n)&&(e.promotion.current={piece:o,promotedPiece:n,key:t,dragged:!!e.draggable.current},e.hovered=t,!0)}function N(e,o,t){return!(!function(e,o,t){return!e.droppable.spare&&e.promotion.dropPromotionDialog(o,t)}(e,o,t)||!Z(e,o,t)&&!oe(e,o,t)||!F(e,o,t))&&(a(e.promotion.events.initiated),!0)}function z(e,o,t){if(function(e,o,t){const n=e.pieces.get(o);return!!n&&e.promotion.movePromotionDialog(o,t)}(e,o,t)&&(W(e,o,t)||ee(e,o,t))){const n=e.pieces.get(o);if(n&&F(e,n,t))return a(e.promotion.events.initiated),!0}return!1}function G(e,o){const t=e.promotion.promotesTo(o.role);return void 0!==t?{color:o.color,role:t}:void 0}function X(e,o,t,n){if(a(e.events.select,o),!e.draggable.enabled&&e.selected===o)return a(e.events.unselect,o),void I(e);if(e.selectable.enabled||n||e.selectable.forceSpares&&e.selectedPiece&&e.droppable.spare){if(e.selectedPiece&&j(e,e.selectedPiece,o,t))return;if(e.selected&&K(e,e.selected,o,t))return}(e.selectable.enabled||e.draggable.enabled||n)&&(Q(e,o)||_(e,o))&&function(e,o){I(e),e.selected=o,Y(e)}(e,o)}function U(e,o,t,n,r){a(e.events.pieceSelect,o),e.selectable.addSparesToHand&&e.droppable.spare&&e.selectedPiece?(D(e,{role:e.selectedPiece.role,color:o.color}),a(e.events.change),I(e)):!r&&!e.draggable.enabled&&e.selectedPiece&&u(e.selectedPiece,o)?(a(e.events.pieceUnselect,o),I(e)):(e.selectable.enabled||e.draggable.enabled||n)&&(V(e,o,!!t)||J(e,o))?(!function(e,o){I(e),e.selectedPiece=o,Y(e)}(e,o),e.droppable.spare=!!t):I(e)}function Y(e){e.premovable.dests=e.predroppable.dests=void 0,e.selected&&_(e,e.selected)&&e.premovable.generate?e.premovable.dests=e.premovable.generate(e.selected,e.pieces):e.selectedPiece&&J(e,e.selectedPiece)&&e.predroppable.generate&&(e.predroppable.dests=e.predroppable.generate(e.selectedPiece,e.pieces))}function I(e){e.selected=e.selectedPiece=e.premovable.dests=e.predroppable.dests=e.promotion.current=void 0}function Q(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function V(e,o,t){var n;return(t||!!(null===(n=e.hands.handMap.get(o.color))||void 0===n?void 0:n.get(o.role)))&&("both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color)}function W(e,o,t){var n,r;return o!==t&&Q(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function Z(e,o,t){var n,r;return V(e,o,e.droppable.spare)&&(e.droppable.free||e.droppable.spare||!!(null===(r=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(C(o)))||void 0===r?void 0:r.includes(t)))}function _(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function J(e,o){var t;return!!(null===(t=e.hands.handMap.get(o.color))||void 0===t?void 0:t.get(o.role))&&e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function ee(e,o,t){return o!==t&&_(e,o)&&!!e.premovable.generate&&e.premovable.generate(o,e.pieces).includes(t)}function oe(e,o,t){const n=e.pieces.get(t);return J(e,o)&&(!n||n.color!==e.activeColor)&&!!e.predroppable.generate&&e.predroppable.generate(o,e.pieces).includes(t)}function te(e,o){return e.draggable.enabled&&("both"===e.activeColor||e.activeColor===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function ne(e){const o=e.premovable.current;if(!o)return!1;const t=o.orig,n=o.dest,r=o.prom;let s=!1;if(W(e,t,n)){const o=H(e,t,n,r);if(o){const i={premade:!0};!0!==o&&(i.captured=o),a(e.movable.events.after,t,n,r,i),s=!0}}return R(e),s}function re(e){const o=e.predroppable.current;if(!o)return!1;const t=o.piece,n=o.key,r=o.prom;let s=!1;return Z(e,t,n)&&$(e,t,n,r)&&(a(e.droppable.events.after,t,n,r,{premade:!0}),s=!0),x(e),s}function se(e){R(e),x(e),I(e)}function ie(e){e.promotion.current&&(I(e),e.promotion.current=void 0,e.hovered=void 0,a(e.promotion.events.cancel))}function ae(e){e.activeColor=e.movable.dests=e.droppable.dests=e.draggable.current=e.animation.current=e.promotion.current=e.hovered=void 0,se(e)}function de(e){const o=e.split("/"),t=o[0].split("");let n=0,r=0;for(const e of t){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:"+"!==e&&(n+=r+1,r=0)}return n+=r,{files:n,ranks:o.length}}function ce(e){switch(e.toLowerCase()){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}function le(e){switch(e){case"pawn":return"p";case"lance":return"l";case"knight":return"n";case"silver":return"s";case"gold":return"g";case"bishop":return"b";case"rook":return"r";case"tokin":return"+p";case"promotedlance":return"+l";case"promotedknight":return"+n";case"promotedsilver":return"+s";case"horse":return"+b";case"dragon":return"+r";case"king":return"k";default:return}}function ue(e,o){o.animation&&(fe(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function pe(e,o){var t,n,s,i,a,d,c,l,u;(null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(s=o.drawable)||void 0===s?void 0:s.shapes)&&(e.drawable.shapes=[]),(null===(i=o.drawable)||void 0===i?void 0:i.autoShapes)&&(e.drawable.autoShapes=[]),(null===(a=o.drawable)||void 0===a?void 0:a.squares)&&(e.drawable.squares=[]),(null===(d=o.hands)||void 0===d?void 0:d.roles)&&(e.hands.roles=[]),fe(e,o),(null===(c=o.sfen)||void 0===c?void 0:c.board)&&(e.dimensions=de(o.sfen.board),e.pieces=function(e,o,t){const n=t||ce,s=new Map;let i=o.files-1,a=0;for(let t=0;t<e.length;t++)switch(e[t]){case" ":case"_":return s;case"/":if(++a,a>o.ranks-1)return s;i=o.files-1;break;default:{const o=e[t].charCodeAt(0),d=e[t+1]&&e[t+1].charCodeAt(0);if(o<58&&o>47)d&&d<58&&d>47?(i-=10*(o-48)+(d-48),t++):i-=o-48;else{const o="+"===e[t]&&e.length>t+1?"+"+e[++t]:e[t],d=n(o);if(i>=0&&d){const e=o===o.toLowerCase()?"gote":"sente";s.set(r([i,a]),{role:d,color:e})}--i}}}return s}(o.sfen.board,e.dimensions,e.forsyth.fromForsyth),e.drawable.shapes=(null===(l=o.drawable)||void 0===l?void 0:l.shapes)||[]),(null===(u=o.sfen)||void 0===u?void 0:u.hands)&&(e.hands.handMap=function(e,o){const t=o||ce,n=new Map,r=new Map;let s=0,i=1;for(let o=0;o<e.length;o++){const a=e[o].charCodeAt(0);if(a<58&&a>47)s=10*s+a-48,i=s;else{const a="+"===e[o]&&e.length>o+1?"+"+e[++o]:e[o],d=t(a);d&&("sente"==(a===a.toLowerCase()?"gote":"sente")?n.set(d,(n.get(d)||0)+i):r.set(d,(r.get(d)||0)+i)),s=0,i=1}}return new Map([["sente",n],["gote",r]])}(o.sfen.hands,e.forsyth.fromForsyth)),"checks"in o&&function(e,o){if(Array.isArray(o))e.checks=o;else if(!0===o&&(o=e.turnColor),o){const t=[];for(const[n,r]of e.pieces)e.highlight.checkRoles.includes(r.role)&&r.color===o&&t.push(n);e.checks=t}else e.checks=void 0}(e,o.checks||!1),"lastDests"in o&&!o.lastDests?e.lastDests=void 0:o.lastDests&&(e.lastDests=o.lastDests),Y(e),ue(e,o)}function fe(e,o){for(const t in o)Object.prototype.hasOwnProperty.call(o,t)&&(Object.prototype.hasOwnProperty.call(e,t)&&he(e[t])&&he(o[t])?fe(e[t],o[t]):e[t]=o[t])}function he(e){if("object"!=typeof e||null===e)return!1;const o=Object.getPrototypeOf(e);return o===Object.prototype||null===o}function ge(o,t){return t.animation.enabled?function(o,t){var r;const s=new Map(t.pieces),i=new Map([["sente",new Map(t.hands.handMap.get("sente"))],["gote",new Map(t.hands.handMap.get("gote"))]]),a=o(t),d=function(o,t,r){const s=new Map,i=[],a=new Map,d=new Map,l=[],p=[],f=new Map;for(const[e,t]of o)f.set(e,ve(e,t));for(const e of n){const o=r.pieces.get(e),t=f.get(e);o?t?u(o,t.piece)||(l.push(t),p.push(ve(e,o))):p.push(ve(e,o)):t&&l.push(t)}if(r.animation.hands)for(const o of e){const e=r.hands.handMap.get(o),n=t.get(o);if(n&&e)for(const[t,s]of n){const n={role:t,color:o};if((e.get(t)||0)<s){const e=r.dom.bounds.hands.pieceBounds().get(C(n)),o=r.dom.bounds.board.bounds(),t=e&&o?q(e.left,e.top,c(r.orientation),r.dimensions,o):void 0;t&&l.push({pos:t,piece:n})}}}for(const e of p){const o=be(e,l.filter((o=>{if(u(e.piece,o.piece))return!0;const t=r.promotion.promotesTo(o.piece.role),n=t&&{color:o.piece.color,role:t},s=r.promotion.promotesTo(e.piece.role),i=s&&{color:e.piece.color,role:s};return!!n&&u(e.piece,n)||!!i&&u(i,o.piece)})));if(o){const t=[o.pos[0]-e.pos[0],o.pos[1]-e.pos[1]];s.set(e.key,t.concat(t)),o.key&&i.push(o.key),!u(e.piece,o.piece)&&e.key&&d.set(e.key,o.piece)}}for(const e of l)e.key&&!i.includes(e.key)&&a.set(e.key,e.piece);return{anims:s,fadings:a,promotions:d}}(s,i,t);if(d.anims.size||d.fadings.size){const e=void 0!==(null===(r=t.animation.current)||void 0===r?void 0:r.start);t.animation.current={start:performance.now(),frequency:1/Math.max(t.animation.duration,1),plan:d},e||we(t,performance.now())}else t.dom.redraw();return a}(o,t):me(o,t)}function me(e,o){const t=e(o);return o.dom.redraw(),t}function ve(e,o){return{key:e,pos:s(e),piece:o}}function be(e,o){return o.sort(((o,t)=>l(e.pos,o.pos)-l(e.pos,t.pos)))[0]}function we(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>we(e,o)))}var r}function Ce(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}const ye="outsideArrow";function ke(e,o,t,n){const r=e.drawable,i=r.current,a=(null==i?void 0:i.dest)?i:void 0,d=!!i&&!a,l=new Map,u=new Map,p=()=>{const o=e.dom.bounds.board.bounds();return o&&o.width.toString()+o.height||""};for(const e of r.shapes.concat(r.autoShapes).concat(a?[a]:[])){const o=Re(e.dest)?C(e.dest):e.dest;xe(e.dest,e.orig)||l.set(o,(l.get(o)||0)+1)}for(const e of r.shapes.concat(a?[a]:[]).concat(r.autoShapes))e.piece&&!Re(e.orig)&&u.set(e.orig,e);const h=[...u.values()].map((e=>({shape:e,hash:Oe(e,l,!1,p)}))),m=r.shapes.concat(r.autoShapes).map((e=>({shape:e,hash:Oe(e,l,!1,p)})));a&&m.push({shape:a,hash:Oe(a,l,!0,p),current:!0});const v=m.map((e=>e.hash)).join(";")+(d?ye:"");if(v===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=v;const b=o.querySelector("defs"),y=o.querySelector("g"),k=t.querySelector("g");if(function(e,o,t){const n=new Set;for(const o of e)xe(o.shape.dest,o.shape.orig)||n.add(o.shape.brush);o&&n.add(o.brush);const r=new Set;let s=t.firstElementChild;for(;s;)r.add(s.getAttribute("sgKey")),s=s.nextElementSibling;for(const e of n){const o=e||"primary";r.has(o)||t.appendChild(De(o))}}(m,d?i:void 0,b),Pe(m.filter((e=>!e.shape.customSvg&&(!e.shape.piece||e.current))),y,(o=>Be(e,o,l)),d),Pe(m.filter((e=>e.shape.customSvg)),k,(o=>Be(e,o,l))),Pe(h,n,(o=>function(e,{shape:o}){if(!o.piece||Re(o.orig))return;const t=o.orig,n=(o.piece.scale||1)*(e.scaleDownPieces?.5:1),r=w("piece",C(o.piece));return r.sgKey=t,r.sgScale=n,g(r,f(e.dimensions)(s(t),c(e.orientation)),e.scaleDownPieces?.5:1,n),r}(e,o))),!d&&i&&(i.arrow=void 0),d&&!i.arrow){const o=$e(i.orig,e);if(o){const t=Ee(Ce("g"),{class:Te(i.brush,!0,!0),sgHash:ye}),n=qe(i.brush,o,o,e.squareRatio,!0,!1);t.appendChild(n),i.arrow=n,y.appendChild(t)}}}function Pe(e,o,t,n){const r=new Map,s=[];for(const o of e)r.set(o.hash,!1);n&&r.set(ye,!0);let i,a=o.firstElementChild;for(;a;)i=a.getAttribute("sgHash"),r.has(i)?r.set(i,!0):s.push(a),a=a.nextElementSibling;for(const e of s)o.removeChild(e);for(const n of e)if(!r.get(n.hash)){const e=t(n);e&&o.appendChild(e)}}function Oe({orig:e,dest:o,brush:t,piece:n,customSvg:r,description:s},i,a,d){return[a,(Re(e)||Re(o))&&d(),Re(e)?Se(e):e,Re(o)?Se(o):o,t,(i.get(Re(o)?C(o):o)||0)>1,n&&Se(n),r&&Me(r),s].filter((e=>e)).join(",")}function Se(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Me(e){let o=0;for(let t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t)>>>0;return"custom-"+o.toString()}function Be(e,{shape:o,current:t,hash:n},r){const s=$e(o.orig,e);if(s){if(o.customSvg)return function(e,o,t,n){const[r,s]=t,i=Ee(Ce("g"),{transform:`translate(${r},${s})`}),a=Ee(Ce("svg"),{class:e,width:n[0],height:n[1],viewBox:`0 0 ${10*n[0]} ${10*n[1]}`});return i.appendChild(a),a.innerHTML=o,i}(o.brush,o.customSvg,s,e.squareRatio);{let i;const a=!xe(o.orig,o.dest)&&$e(o.dest,e);if(a)i=qe(o.brush,s,a,e.squareRatio,!!t,(r.get(Re(o.dest)?C(o.dest):o.dest)||0)>1);else if(xe(o.dest,o.orig)){let n=e.squareRatio;if(Re(o.orig)){const t=e.dom.bounds.hands.pieceBounds().get(C(o.orig)),r=e.dom.bounds.board.bounds();if(t&&r){const o=t.height/(r.height/e.dimensions.ranks);n=[o*e.squareRatio[0],o*e.squareRatio[1]]}}i=function(e,o,t){const n=e,r=function(e){return[3/64*Ae(e),4/64*Ae(e)]}(o);return Ee(Ce("ellipse"),{"stroke-width":r[t?0:1],fill:"none",cx:n[0],cy:n[1],rx:o[0]/2-r[1]/2,ry:o[1]/2-r[1]/2})}(s,n,!!t)}if(i){const s=Ee(Ce("g"),{class:Te(o.brush,!!t,!1),sgHash:n});s.appendChild(i);const a=o.description&&function(e,o,t){const n=$e(o.orig,e);if(!n||!o.description)return;const r=!xe(o.orig,o.dest)&&$e(o.dest,e),s=r?[r[0]-n[0],r[1]-n[1]]:[0,0],i=(t.get(Re(o.dest)?C(o.dest):o.dest)||0)>1?.3:.15,a=!(0!==s[0]&&Math.abs(s[0])!==e.squareRatio[0]||0!==s[1]&&Math.abs(s[1])!==e.squareRatio[1]),d=r?.55-(a?i:0):0,c=[n[0]+s[0]*d,n[1]+s[1]*d],l=o.description.length,u=Ee(Ce("g"),{class:"description"}),p=Ee(Ce("ellipse"),{cx:c[0],cy:c[1],rx:l+1.5,ry:2.5}),f=Ee(Ce("text"),{x:c[0],y:c[1],"text-anchor":"middle","dominant-baseline":"central"});return u.appendChild(p),f.appendChild(document.createTextNode(o.description)),u.appendChild(f),u}(e,o,r);return a&&s.appendChild(a),s}return}}}function qe(e,o,t,n,r,s){const i=function(e,o){return(e?20:10)/64*Ae(o)}(s&&!r,n),a=o,d=t,c=d[0]-a[0],l=d[1]-a[1],u=Math.atan2(l,c),p=Math.cos(u)*i,f=Math.sin(u)*i;return Ee(Ce("line"),{"stroke-width":He(r,n),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+(e||"primary")+")",x1:a[0],y1:a[1],x2:d[0]-p,y2:d[1]-f})}function De(e){const o=Ee(Ce("marker"),{id:"arrowhead-"+e,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(Ee(Ce("path"),{d:"M0,0 V4 L3,2 Z"})),o.setAttribute("sgKey",e),o}function Ee(e,o){for(const t in o)Object.prototype.hasOwnProperty.call(o,t)&&e.setAttribute(t,o[t]);return e}function Le(e,o,t,n){return"sente"===o?[(t.files-1-e[0])*n[0],e[1]*n[1]]:[e[0]*n[0],(t.ranks-1-e[1])*n[1]]}function Re(e){return"object"==typeof e}function xe(e,o){return Re(e)&&Re(o)&&u(e,o)||e===o}function Te(e,o,t){return e+(o?" current":"")+(t?" outside":"")}function Ae(e){return(e[0]+e[1])/2}function He(e,o){return(e?8.5:10)/64*Ae(o)}function $e(e,o){if(Re(e)){const t=o.dom.bounds.hands.pieceBounds().get(C(e)),n=o.dom.bounds.board.bounds(),r=c(o.orientation)?[.5,-.5]:[-.5,.5],s=t&&n&&q(t.left+t.width/2,t.top+t.height/2,c(o.orientation),o.dimensions,n);return s&&Le([s[0]+r[0],s[1]+r[1]],o.orientation,o.dimensions,o.squareRatio)}return Le(s(e),o.orientation,o.dimensions,o.squareRatio)}const je=["primary","alternative0","alternative1","alternative2"];function Ke(e){requestAnimationFrame((()=>{const o=e.drawable.current,t=e.dom.bounds.board.bounds();if(o&&t){const n=M(o.pos,c(e.orientation),e.dimensions,t)||B(o.pos,e.hands.roles,e.dom.bounds.hands.pieceBounds());o.dest===n||o.dest&&n&&xe(n,o.dest)||(o.dest=n,e.dom.redrawNow());const r=q(o.pos[0],o.pos[1],c(e.orientation),e.dimensions,t);if(!o.dest&&o.arrow&&r){const t=Le(r,e.orientation,e.dimensions,e.squareRatio);Ee(o.arrow,{x2:t[0]-e.squareRatio[0]/2,y2:t[1]-e.squareRatio[1]/2})}Ke(e)}}))}function Fe(e,o){e.drawable.current&&(e.drawable.current.pos=v(o))}function Ne(e,o){const t=e.drawable.current;t&&(!function(e,o){if(!o.dest)return;const t=e=>o.dest&&xe(o.orig,e.orig)&&xe(o.dest,e.dest),n=o.piece;o.piece=void 0;const r=e.shapes.find(t),s=e.shapes.find((e=>t(e)&&n&&e.piece&&u(n,e.piece))),i=e.shapes.find((e=>t(e)&&n&&e.piece&&!u(n,e.piece)));r&&(e.shapes=e.shapes.filter((e=>!t(e))));Re(o.orig)||!n||s||(e.shapes.push({orig:o.orig,dest:o.orig,piece:n,brush:o.brush}),xe(o.orig,o.dest)||e.shapes.push({orig:o.orig,dest:o.orig,brush:o.brush}));r&&!i&&r.brush===o.brush||e.shapes.push(o);Ue(e)}(e.drawable,t),ze(e))}function ze(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ge(e){const o=e.drawable.shapes.length;(o||e.drawable.piece)&&(e.drawable.shapes=[],e.drawable.piece=void 0,e.dom.redraw(),o&&Ue(e.drawable))}function Xe(e,o){var t;const n=o&&(e.shiftKey||e.ctrlKey),r=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return je[(n?1:0)+(r?2:0)]}function Ue(e){e.onChange&&e.onChange(e.shapes)}function Ye(e,o){var t;const n=e.dom.bounds.board.bounds(),r=v(o),s=n&&r&&M(r,c(e.orientation),e.dimensions,n);if(!s)return;const i=e.pieces.get(s),d=e.selected;d||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||Ge(e),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||e.selectedPiece||i||d||function(e,o,t){const n=c(e.orientation),r=Math.pow(t.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=P(s,n,e.dimensions,t);if(l(i,o)<=r)return!0}return!1}(e,r,n))&&o.preventDefault();const u=!!e.premovable.current,p=!!e.predroppable.current;var f,h;e.selectable.deleteOnTouch?(h=s,(f=e).pieces.delete(h)&&a(f.events.change)):e.selected?z(e,e.selected,s)||(W(e,e.selected,s)?ge((e=>X(e,s)),e):X(e,s)):e.selectedPiece?N(e,e.selectedPiece,s)||(Z(e,e.selectedPiece,s)?ge((e=>X(e,s)),e):X(e,s)):X(e,s);const g=e.selected===s,m=null===(t=e.dom.elements.board)||void 0===t?void 0:t.dragged;if(i&&m&&g&&te(e,i)){const t="touchstart"===o.type;e.draggable.current={piece:i,pos:r,origPos:r,started:e.draggable.autoDistance&&!t,touch:t,originTarget:o.target,fromBoard:{orig:s,previouslySelected:d,keyHasChanged:!1}},m.sgColor=i.color,m.sgRole=i.role,m.className=`dragging ${C(i)}`,m.classList.toggle("touch",t),Qe(e)}else u&&R(e),p&&x(e);e.dom.redraw()}function Ie(e,o,t,n){var r;const s=e.selectedPiece,i=null===(r=e.dom.elements.board)||void 0===r?void 0:r.dragged,a=v(t),d="touchstart"===t.type;!s&&!n&&e.drawable.enabled&&e.drawable.eraseOnClick&&Ge(e),!n&&e.selectable.deleteOnTouch?E(e,o):U(e,o,n);const c=!!e.premovable.current,l=!!e.predroppable.current,p=e.selectedPiece&&u(e.selectedPiece,o);i&&a&&e.selectedPiece&&p&&te(e,o)?(e.draggable.current={piece:e.selectedPiece,pos:a,origPos:a,touch:d,started:e.draggable.autoDistance&&!d,originTarget:t.target,fromOutside:{originBounds:n?void 0:e.dom.bounds.hands.pieceBounds().get(C(o)),leftOrigin:!1,previouslySelectedPiece:n?void 0:s}},i.sgColor=o.color,i.sgRole=o.role,i.className=`dragging ${C(o)}`,i.classList.toggle("touch",d),Qe(e)):(c&&R(e),l&&x(e)),e.dom.redraw()}function Qe(e){requestAnimationFrame((()=>{var o,t,n,r;const i=e.draggable.current,a=null===(o=e.dom.elements.board)||void 0===o?void 0:o.dragged,d=e.dom.bounds.board.bounds();if(!i||!a||!d)return;(null===(t=i.fromBoard)||void 0===t?void 0:t.orig)&&(null===(n=e.animation.current)||void 0===n?void 0:n.plan.anims.has(i.fromBoard.orig))&&(e.animation.current=void 0);const f=i.fromBoard?e.pieces.get(i.fromBoard.orig):i.piece;if(f&&u(f,i.piece)){if(!i.started&&l(i.pos,i.origPos)>=Math.pow(e.draggable.distance,2)&&(i.started=!0,e.dom.redraw()),i.started){h(a,[i.pos[0]-d.left-d.width/(2*e.dimensions.files),i.pos[1]-d.top-d.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),a.sgDragging||(a.sgDragging=!0,m(a,!0));const o=M(i.pos,c(e.orientation),e.dimensions,d);i.fromBoard?i.fromBoard.keyHasChanged=i.fromBoard.keyHasChanged||i.fromBoard.orig!==o:i.fromOutside&&(i.fromOutside.leftOrigin=i.fromOutside.leftOrigin||!!i.fromOutside.originBounds&&!S(i.fromOutside.originBounds,i.pos)),o!==e.hovered&&(eo(e,o),i.touch&&(null===(r=e.dom.elements.board)||void 0===r?void 0:r.squareOver)&&(o&&e.draggable.showTouchSquareOverlay?(h(e.dom.elements.board.squareOver,((e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>p(o,e,r,t,n)})(e.dimensions,d)(s(o),c(e.orientation)),1),m(e.dom.elements.board.squareOver,!0)):m(e.dom.elements.board.squareOver,!1)))}}else _e(e);Qe(e)}))}function Ve(e,o){if(e.draggable.current&&(!o.touches||o.touches.length<2))e.draggable.current.pos=v(o);else if((e.selected||e.selectedPiece||e.highlight.hovered)&&!e.draggable.current&&(!o.touches||o.touches.length<2)){const t=e.dom.bounds.board.bounds(),n=t&&M(v(o),c(e.orientation),e.dimensions,t);n!==e.hovered&&eo(e,n)}}function We(e,o){var t,n,r;const s=e.draggable.current;if(!s)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&s.originTarget!==o.target&&!s.fromOutside)return e.draggable.current=void 0,void(e.hovered&&!e.highlight.hovered&&eo(e,void 0));R(e),x(e);const i=v(o)||s.pos,l=e.dom.bounds.board.bounds(),p=l&&M(i,c(e.orientation),e.dimensions,l);if(p&&s.started&&(null===(t=s.fromBoard)||void 0===t?void 0:t.orig)!==p)s.fromOutside&&!N(e,s.piece,p)?j(e,s.piece,p):s.fromBoard&&!z(e,s.fromBoard.orig,p)&&K(e,s.fromBoard.orig,p);else if(e.draggable.deleteOnDropOff&&!p){if(s.fromBoard?e.pieces.delete(s.fromBoard.orig):s.fromOutside&&!e.droppable.spare&&E(e,s.piece),e.draggable.addToHandOnDropOff){const o=e.dom.bounds.hands.bounds(),t=o.get("top"),n=o.get("bottom");t&&S(t,s.pos)?D(e,{color:d(e.orientation),role:s.piece.role}):n&&S(n,s.pos)&&D(e,{color:e.orientation,role:s.piece.role})}a(e.events.change)}!s.fromBoard||s.fromBoard.orig!==s.fromBoard.previouslySelected&&!s.fromBoard.keyHasChanged||s.fromBoard.orig!==p&&p?!p&&(null===(n=s.fromOutside)||void 0===n?void 0:n.leftOrigin)||(null===(r=s.fromOutside)||void 0===r?void 0:r.originBounds)&&S(s.fromOutside.originBounds,s.pos)&&s.fromOutside.previouslySelectedPiece&&u(s.fromOutside.previouslySelectedPiece,s.piece)?Ze(e,s,p):e.selectable.enabled||e.promotion.current||Ze(e,s,p):Ze(e,s,p),e.draggable.current=void 0,e.highlight.hovered||e.promotion.current||(e.hovered=void 0),e.dom.redraw()}function Ze(e,o,t){var n;o.fromBoard&&o.fromBoard.orig===t?a(e.events.unselect,o.fromBoard.orig):(null===(n=o.fromOutside)||void 0===n?void 0:n.originBounds)&&S(o.fromOutside.originBounds,o.pos)&&a(e.events.pieceUnselect,o.piece),I(e)}function _e(e){e.draggable.current&&(e.draggable.current=void 0,e.highlight.hovered||(e.hovered=void 0),I(e),e.dom.redraw())}function Je(e){return!e.isTrusted||void 0!==e.button&&0!==e.button||!!e.touches&&e.touches.length>1}function eo(e,o){var t;const n=null===(t=e.dom.elements.board)||void 0===t?void 0:t.squares.children;if(!n||e.promotion.current)return;const r=e.hovered;e.highlight.hovered||o&&function(e,o){return!!e.selected&&(W(e,e.selected,o)||ee(e,e.selected,o))||!!e.selectedPiece&&(Z(e,e.selectedPiece,o)||oe(e,e.selectedPiece,o))}(e,o)?e.hovered=o:e.hovered=void 0;const s=c(e.orientation),i=e.hovered&&O(e.hovered,s,e.dimensions),a=void 0!==i&&n[i];a&&a.classList.add("hover");const d=r&&O(r,s,e.dimensions),l=void 0!==d&&n[d];l&&l.classList.remove("hover")}function oo(e){switch(e){case 1:return["十六","十五","十四","十三","十二","十一","十","九","八","七","六","五","四","三","二","一"];case 2:return["p","o","n","m","l","k","j","i","h","g","f","e","d","c","b","a"];case 3:return["10","f","e","d","c","b","a","9","8","7","6","5","4","3","2","1"];default:return["16","15","14","13","12","11","10","9","8","7","6","5","4","3","2","1"]}}function to(o,t){const n=w("sg-board"),s=function(e,o){const t=w("sg-squares");for(let n=0;n<e.ranks*e.files;n++){const s=w("sq");s.sgKey=r("sente"===o?[e.files-1-n%e.files,Math.floor(n/e.files)]:[n%e.files,e.ranks-1-Math.floor(n/e.files)]),t.appendChild(s)}return t}(t.dimensions,t.orientation);n.appendChild(s);const i=w("sg-pieces");let a,d,c,l;if(n.appendChild(i),t.viewOnly||(a=w("piece"),m(a,!1),n.appendChild(a),d=w("sg-promotion"),m(d,!1),n.appendChild(d),c=w("sg-square-over"),m(c,!1),n.appendChild(c)),t.drawable.visible){const e=Ee(Ce("svg"),{class:"sg-shapes",viewBox:`-${t.squareRatio[0]/2} -${t.squareRatio[1]/2} ${t.dimensions.files*t.squareRatio[0]} ${t.dimensions.ranks*t.squareRatio[1]}`});e.appendChild(Ce("defs")),e.appendChild(Ce("g"));const o=Ee(Ce("svg"),{class:"sg-custom-svgs",viewBox:`0 0 ${t.dimensions.files*t.squareRatio[0]} ${t.dimensions.ranks*t.squareRatio[1]}`});o.appendChild(Ce("g"));const r=w("sg-free-pieces");n.appendChild(e),n.appendChild(o),n.appendChild(r),l={svg:e,freePieces:r,customSvg:o}}if(t.coordinates.enabled){const e="gote"===t.orientation?" gote":"",o=oo(t.coordinates.ranks),r=oo(t.coordinates.files);n.appendChild(ro(o,"ranks"+e,t.dimensions.ranks)),n.appendChild(ro(r,"files"+e,t.dimensions.files))}o.innerHTML="";const u=`d-${t.dimensions.files}x${t.dimensions.ranks}`;o.classList.forEach((e=>{"d-"===e.substring(0,2)&&e!==u&&o.classList.remove(e)})),o.classList.add("sg-wrap",u);for(const n of e)o.classList.toggle("orientation-"+n,t.orientation===n);let p;if(o.classList.toggle("manipulable",!t.viewOnly),o.appendChild(n),t.hands.inlined){const e=w("sg-hand-wrap","inlined"),t=w("sg-hand-wrap","inlined");o.insertBefore(t,n.nextElementSibling),o.insertBefore(e,n),p={top:e,bottom:t}}return{board:n,squares:s,pieces:i,promotion:d,squareOver:c,dragged:a,shapes:l,hands:p}}function no(o,t,n){const r=function(e,o){const t=w("sg-hand");for(const n of o){const o={role:n,color:e},r=w("sg-hp-wrap"),s=w("piece",C(o));s.sgColor=e,s.sgRole=n,r.appendChild(s),t.appendChild(r)}return t}("top"===t?d(n.orientation):n.orientation,n.hands.roles);o.innerHTML="";const s=`r-${n.hands.roles.length}`;o.classList.forEach((e=>{"r-"===e.substring(0,2)&&e!==s&&o.classList.remove(e)})),o.classList.add("sg-hand-wrap",`hand-${t}`,s),o.appendChild(r);for(const t of e)o.classList.toggle("orientation-"+t,n.orientation===t);return o.classList.toggle("manipulable",!n.viewOnly),r}function ro(e,o,t){const n=w("coords",o);let r;for(const o of e.slice(-t))r=w("coord"),r.textContent=o,n.appendChild(r);return n}function so(e){e.dom.bounds.board.bounds.clear(),e.dom.bounds.hands.bounds.clear(),e.dom.bounds.hands.pieceBounds.clear()}function io(e){return()=>{so(e),e.drawable.shapes.concat(e.drawable.autoShapes).some((e=>Re(e.orig)||Re(e.dest)))&&e.dom.redrawShapes()}}function ao(e,o){if("ResizeObserver"in window&&new ResizeObserver(io(e)).observe(o.board),e.viewOnly)return;const t=o.pieces,n=o.promotion,r=function(e){return o=>{e.draggable.current?_e(e):e.drawable.current?ze(e):o.shiftKey||b(o)||e.drawable.forced?e.drawable.enabled&&function(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?I(e):se(e);const t=v(o),n=e.dom.bounds.board.bounds(),r=t&&n&&M(t,c(e.orientation),e.dimensions,n),s=e.drawable.piece;r&&(e.drawable.current={orig:r,dest:void 0,pos:t,piece:s,brush:Xe(o,b(o)||e.drawable.forced)},Ke(e))}(e,o):e.viewOnly||Je(o)||Ye(e,o)}}(e);if(t.addEventListener("touchstart",r,{passive:!1}),t.addEventListener("mousedown",r,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault())),n){const o=o=>function(e,o){o.stopPropagation();const t=o.target,n=e.promotion.current;if(t&&y(t)&&n){const o={color:t.sgColor,role:t.sgRole},r=!u(n.piece,o);n.dragged||e.turnColor!==e.activeColor&&"both"!==e.activeColor?e.selected?K(e,e.selected,n.key,r):e.selectedPiece&&j(e,e.selectedPiece,n.key,r):ge((e=>X(e,n.key,r)),e),a(e.promotion.events.after,o)}else ge((e=>ie(e)),e);e.promotion.current=void 0,e.dom.redraw()}(e,o);n.addEventListener("click",o),e.disableContextMenu&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}}function co(e,o){if("ResizeObserver"in window&&new ResizeObserver(io(e)).observe(o),e.viewOnly)return;const t=function(e){return o=>{if(e.promotion.current)return;const t=v(o),n=t&&B(t,e.hands.roles,e.dom.bounds.hands.pieceBounds());n&&(e.draggable.current?_e(e):e.drawable.current?ze(e):(e=>4===e.buttons||1===e.button)(o)?e.drawable.enabled&&(!1!==o.cancelable&&o.preventDefault(),function(e,o){e.drawable.piece&&u(e.drawable.piece,o)?e.drawable.piece=void 0:e.drawable.piece=o,e.dom.redraw()}(e,n)):o.shiftKey||b(o)||e.drawable.forced?e.drawable.enabled&&function(e,o,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?I(e):se(e);const n=v(t);n&&(e.drawable.current={orig:o,dest:void 0,pos:n,brush:Xe(t,b(t)||e.drawable.forced)},Ke(e))}(e,n,o):e.viewOnly||Je(o)||(!1!==o.cancelable&&o.preventDefault(),Ie(e,n,o)))}}(e);o.addEventListener("mousedown",t,{passive:!1}),o.addEventListener("touchstart",t,{passive:!1}),o.addEventListener("click",(()=>{e.promotion.current&&(ie(e),e.dom.redraw())})),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function lo(e){const o=[];if("ResizeObserver"in window||o.push(uo(document.body,"shogiground.resize",io(e))),!e.viewOnly){const t=po(e,Ve,Fe),n=po(e,We,Ne);for(const e of["touchmove","mousemove"])o.push(uo(document,e,t));for(const e of["touchend","mouseup"])o.push(uo(document,e,n));o.push(uo(document,"scroll",(()=>so(e)),{capture:!0,passive:!0})),o.push(uo(window,"resize",(()=>so(e)),{passive:!0}))}return()=>o.forEach((e=>e()))}function uo(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function po(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function fo(e,o){var t,n,r;const i=c(e.orientation),a=e.scaleDownPieces?.5:1,d=f(e.dimensions),l=o.squares,u=o.pieces,p=o.dragged,h=o.squareOver,v=o.promotion,b=e.pieces,P=e.animation.current,O=P?P.plan.anims:new Map,S=P?P.plan.fadings:new Map,M=P?P.plan.promotions:new Map,B=e.draggable.current,q=(null===(t=e.promotion.current)||void 0===t?void 0:t.dragged)?e.selected:void 0,D=function(e){var o,t;const n=new Map;if(e.lastDests&&e.highlight.lastDests)for(const o of e.lastDests)go(n,o,"last-dest");if(e.checks&&e.highlight.check)for(const o of e.checks)go(n,o,"check");e.hovered&&go(n,e.hovered,"hover");if(e.selected){if("both"===e.activeColor||e.activeColor===e.turnColor?go(n,e.selected,"selected"):go(n,e.selected,"preselected"),e.movable.showDests){const t=null===(o=e.movable.dests)||void 0===o?void 0:o.get(e.selected);if(t)for(const o of t)go(n,o,"dest"+(e.pieces.has(o)?" oc":""));const r=e.premovable.dests;if(r)for(const o of r)go(n,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.selectedPiece&&e.droppable.showDests){const o=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(C(e.selectedPiece));if(o)for(const e of o)go(n,e,"dest");const r=e.predroppable.dests;if(r)for(const o of r)go(n,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}const r=e.premovable.current;r?(go(n,r.orig,"current-pre"),go(n,r.dest,"current-pre"+(r.prom?" prom":""))):e.predroppable.current&&go(n,e.predroppable.current.key,"current-pre"+(e.predroppable.current.prom?" prom":""));for(const o of e.drawable.squares)go(n,o.key,o.className);return n}(e),E=new Set,L=new Map;let R,x,T,A,H,$,j,K,F;for(!B&&(null==p?void 0:p.sgDragging)&&(p.sgDragging=!1,m(p,!1),h&&m(h,!1)),x=u.firstElementChild;x;){if(y(x))if(R=x.sgKey,T=b.get(R),H=O.get(R),$=S.get(R),j=M.get(R),A=C({color:x.sgColor,role:x.sgRole}),((null==B?void 0:B.started)&&(null===(n=B.fromBoard)||void 0===n?void 0:n.orig)===R||q&&q===R)&&!x.sgGhost?(x.sgGhost=!0,x.classList.add("ghost")):!x.sgGhost||B&&(null===(r=B.fromBoard)||void 0===r?void 0:r.orig)===R||q&&q===R||(x.sgGhost=!1,x.classList.remove("ghost")),!$&&x.sgFading&&(x.sgFading=!1,x.classList.remove("fading")),T){if(H&&x.sgAnimating&&(A===C(T)||j&&A===C(j))){const e=s(R);e[0]+=H[2],e[1]+=H[3],g(x,d(e,i),a)}else x.sgAnimating&&(x.sgAnimating=!1,x.classList.remove("anim"),g(x,d(s(R),i),a));A!==C(T)||$&&x.sgFading?$&&A===C($)?(x.sgFading=!0,x.classList.add("fading")):j&&A===C(j)?E.add(R):ho(L,A,x):E.add(R)}else ho(L,A,x);x=x.nextElementSibling}let N=l.firstElementChild;for(;N&&k(N);)N.className=D.get(N.sgKey)||"",N=N.nextElementSibling;for(const[e,o]of b){const t=M.get(e)||o;if(H=O.get(e),!E.has(e))if(K=L.get(C(t)),F=null==K?void 0:K.pop(),F){F.sgKey=e,F.sgFading&&(F.sgFading=!1,F.classList.remove("fading"));const o=s(e);H&&(F.sgAnimating=!0,F.classList.add("anim"),o[0]+=H[2],o[1]+=H[3]),g(F,d(o,i),a)}else{const t=w("piece",C(o)),n=s(e);t.sgColor=o.color,t.sgRole=o.role,t.sgKey=e,H&&(t.sgAnimating=!0,n[0]+=H[2],n[1]+=H[3]),g(t,d(n,i),a),u.appendChild(t)}}for(const e of L.values())for(const o of e)u.removeChild(o);v&&function(e,o){const t=e.promotion.current,n=null==t?void 0:t.key,r=t?[t.promotedPiece,t.piece]:[],i=function(e,o,t){return[e,o,t.map((e=>C(e))).join(" ")].join(" ")}(!!t,n,r);if(e.promotion.prevPromotionHash===i)return;if(e.promotion.prevPromotionHash=i,n){const i=c(e.orientation),a=s(n),d=t.piece.color,l=w("sg-promotion-square"),u=w("sg-promotion-choices");e.orientation!==d&&u.classList.add("reversed"),g(l,f(e.dimensions)(a,i),1);for(const e of r){const o=w("piece",C(e));o.sgColor=e.color,o.sgRole=e.role,u.appendChild(o)}o.innerHTML="",l.appendChild(u),o.appendChild(l),m(o,!0)}else m(o,!1)}(e,v)}function ho(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function go(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function mo(e,o,t){if(e.dom.elements.hands||(e.dom.elements.hands={}),e.dom.wrapElements.hands||(e.dom.wrapElements.hands={}),o){const t=no(o,"top",e);e.dom.wrapElements.hands.top=o,e.dom.elements.hands.top=t,co(e,t),L(e,t)}if(t){const o=no(t,"bottom",e);e.dom.wrapElements.hands.bottom=t,e.dom.elements.hands.bottom=o,co(e,o),L(e,o)}(o||t)&&(e.dom.bounds.hands.bounds.clear(),e.dom.bounds.hands.pieceBounds.clear())}function vo(e,o){var t,n,r,s;e.board&&function(e,o){const t=to(o,e);t.hands&&mo(e,t.hands.top,t.hands.bottom),e.dom.wrapElements.board=o,e.dom.elements.board=t,e.dom.bounds.board.bounds.clear(),ao(e,t),e.drawable.prevSvgHash="",e.promotion.prevPromotionHash="",fo(e,t)}(o,e.board),e.hands&&!o.hands.inlined&&mo(o,e.hands.top,e.hands.bottom),o.dom.redrawShapes(),o.events.insert&&o.events.insert(e.board&&o.dom.elements.board,{top:(null===(t=e.hands)||void 0===t?void 0:t.top)&&(null===(n=o.dom.elements.hands)||void 0===n?void 0:n.top),bottom:(null===(r=e.hands)||void 0===r?void 0:r.bottom)&&(null===(s=o.dom.elements.hands)||void 0===s?void 0:s.bottom)})}function bo(e){return{attach(o){vo(o,e)},detach(o){!function(e,o){var t,n,r,s;e.board&&(o.dom.wrapElements.board=void 0,o.dom.elements.board=void 0,o.dom.bounds.board.bounds.clear()),o.dom.elements.hands&&o.dom.wrapElements.hands&&((null===(t=e.hands)||void 0===t?void 0:t.top)&&(o.dom.wrapElements.hands.top=void 0,o.dom.elements.hands.top=void 0),(null===(n=e.hands)||void 0===n?void 0:n.bottom)&&(o.dom.wrapElements.hands.bottom=void 0,o.dom.elements.hands.bottom=void 0),((null===(r=e.hands)||void 0===r?void 0:r.top)||(null===(s=e.hands)||void 0===s?void 0:s.bottom))&&(o.dom.bounds.hands.bounds.clear(),o.dom.bounds.hands.pieceBounds.clear()))}(o,e)},set(o,t){var n,r,s,i;function a(e,o){return e.split(".").reduce(((e,o)=>e&&e[o]),o)}const d=(null===(n=o.sfen)||void 0===n?void 0:n.board)&&de(o.sfen.board);["orientation","viewOnly","coordinates.enabled","coordinates.notation","drawable.visible","hands.inlined"].some((t=>{const n=a(t,o);return n&&n!==a(t,e)}))||!(!d||d.files===e.dimensions.files&&d.ranks===e.dimensions.ranks)||!!(null===(s=null===(r=o.hands)||void 0===r?void 0:r.roles)||void 0===s?void 0:s.every(((o,t)=>o===e.hands.roles[t])))?(!function(e){I(e),R(e),x(e),ie(e),e.animation.current=e.draggable.current=e.hovered=void 0}(e),pe(e,o),vo(e.dom.wrapElements,e)):(ue(e,o),((null===(i=o.sfen)||void 0===i?void 0:i.board)&&!t?ge:me)((e=>pe(e,o)),e))},state:e,getBoardSfen:()=>function(e,n,r){const s=r||le,i=o.slice(0,n.files).reverse();return t.slice(0,n.ranks).map((o=>i.map((t=>{const n=e.get(t+o),r=n&&s(n.role);return r?"sente"===n.color?r.toUpperCase():r.toLowerCase():"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions,e.forsyth.toForsyth),getHandsSfen:()=>function(e,o,t){var n,r;const s=t||le;let i="",a="";for(const t of o){const o=s(t);if(o){const s=null===(n=e.get("sente"))||void 0===n?void 0:n.get(t),d=null===(r=e.get("gote"))||void 0===r?void 0:r.get(t);s&&(i+=s>1?s.toString()+o:o),d&&(a+=d>1?d.toString()+o:o)}}return i||a?i.toUpperCase()+a.toLowerCase():"-"}(e.hands.handMap,e.hands.roles,e.forsyth.toForsyth),toggleOrientation(){!function(e){e.orientation=d(e.orientation),e.animation.current=e.draggable.current=e.promotion.current=e.hovered=e.selected=e.selectedPiece=void 0}(e),vo(e.dom.wrapElements,e)},move(o,t,n){ge((e=>T(e,o,t,n||e.promotion.forceMovePromotion(o,t))),e)},drop(o,t,n,r){ge((e=>{e.droppable.spare=!!r,A(e,o,t,n||e.promotion.forceDropPromotion(o,t))}),e)},setPieces(o){ge((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},addToHand(o,t){me((e=>D(e,o,t)),e)},removeFromHand(o,t){me((e=>E(e,o,t)),e)},selectSquare(o,t,n){o?ge((e=>X(e,o,t,n)),e):e.selected&&(I(e),e.dom.redraw())},selectPiece(o,t,n){o?me((e=>U(e,o,t,n,!0)),e):e.selectedPiece&&(I(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(ge(ne,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){if(ge(re,e))return!0;e.dom.redraw()}return!1},cancelPremove(){me(R,e)},cancelPredrop(){me(x,e)},cancelMoveOrDrop(){me((e=>{se(e),_e(e)}),e)},stop(){me((e=>{ae(e)}),e)},setAutoShapes(o){me((e=>e.drawable.autoShapes=o),e)},setShapes(o){me((e=>e.drawable.shapes=o),e)},setSquareHighlights(o){me((e=>e.drawable.squares=o),e)},dragNewPiece(o,t,n){Ie(e,o,t,n)},destroy(){ae(e),e.dom.unbind(),e.dom.destroyed=!0}}}function wo(e){var o;(null===(o=e.dom.elements.board)||void 0===o?void 0:o.shapes)&&ke(e,e.dom.elements.board.shapes.svg,e.dom.elements.board.shapes.customSvg,e.dom.elements.board.shapes.freePieces)}function Co(e){let o=!1;return(...t)=>{o||(o=!0,requestAnimationFrame((()=>{e(...t),o=!1})))}}return function(e,o){const t={pieces:new Map,dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,squareRatio:[11,12],disableContextMenu:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,files:0,ranks:0},highlight:{lastDests:!0,check:!0,checkRoles:["king"],hovered:!1},animation:{enabled:!0,hands:!0,duration:250},hands:{inlined:!1,handMap:new Map([["sente",new Map],["gote",new Map]]),roles:["rook","bishop","gold","silver","knight","lance","pawn"]},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,spare:!1,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1,addToHandOnDropOff:!1},selectable:{enabled:!0,forceSpares:!1,deleteOnTouch:!1,addSparesToHand:!1},promotion:{movePromotionDialog:()=>!1,forceMovePromotion:()=>!1,dropPromotionDialog:()=>!1,forceDropPromotion:()=>!1,promotesTo:()=>{},unpromotesTo:()=>{},events:{},prevPromotionHash:""},forsyth:{},events:{},drawable:{enabled:!0,visible:!0,forced:!1,eraseOnClick:!0,shapes:[],autoShapes:[],squares:[],prevSvgHash:""}};pe(t,e||{});const n=e=>{!function(e,o){const t=e.dom.elements.board;t&&(fo(e,t),o||wo(e));const n=e.dom.elements.hands;n&&(n.top&&L(e,n.top),n.bottom&&L(e,n.bottom))}(t,e)};return t.dom={wrapElements:o||{},elements:{},bounds:{board:{bounds:i((()=>{var e;return null===(e=t.dom.elements.board)||void 0===e?void 0:e.pieces.getBoundingClientRect()}))},hands:{bounds:i((()=>{const e=new Map,o=t.dom.elements.hands;return(null==o?void 0:o.top)&&e.set("top",o.top.getBoundingClientRect()),(null==o?void 0:o.bottom)&&e.set("bottom",o.bottom.getBoundingClientRect()),e})),pieceBounds:i((()=>{const e=new Map,o=t.dom.elements.hands;if(null==o?void 0:o.top){let t=o.top.firstElementChild;for(;t;){const o=t.firstElementChild,n={role:o.sgRole,color:o.sgColor};e.set(C(n),o.getBoundingClientRect()),t=t.nextElementSibling}}if(null==o?void 0:o.bottom){let t=o.bottom.firstElementChild;for(;t;){const o=t.firstElementChild,n={role:o.sgRole,color:o.sgColor};e.set(C(n),o.getBoundingClientRect()),t=t.nextElementSibling}}return e}))}},redrawNow:n,redraw:Co(n),redrawShapes:Co((()=>wo(t))),unbind:lo(t),destroyed:!1},o&&vo(o,t),bo(t)}}();
